\usepackage{graphicx}

\usepackage{amsmath}
\usepackage{xcolor}
\usepackage{color}
\usepackage{listings}
\usepackage{etoolbox}

\definecolor{orange}{rgb}{1,0.5,0}
\definecolor{green}{rgb}{0,0.5,0}
\definecolor{gray}{rgb}{0.25,0.25,0.25}
\definecolor{mauve}{rgb}{0.58,0,0.82}
\definecolor{red}{rgb}{1.0,0,0}

\colorlet{punct}{green}
\colorlet{delim}{green}
\colorlet{num}{mauve}

\definecolor{codebg}{rgb}{1.0,1.0,0.8}
\definecolor{jargonbg}{rgb}{0.8,1.0,0.8}
\definecolor{spacebg}{rgb}{1.0,0.8,0.0}
\definecolor{lightspacebg}{rgb}{1.0,0.9,0.5}

\newtoggle{InString}{}% Keep track of if we are within a string
\togglefalse{InString}% Assume not initally in string

\newcommand*{\ColorIfNotInString}[1]{\iftoggle{InString}{#1}{\color{num}#1}}
\newcommand*{\ProcessQuote}[1]{\color{red}#1\iftoggle{InString}{\global\togglefalse{InString}}{\global\toggletrue{InString}}}

\lstdefinelanguage{py}{
	morekeywords={if,elif,else,for,in,while,break,continue,def,class,True,False,print,return,and,or,not,with,None,try,except,finally,raise,as},
	literate=
	*{=}{{{\color{punct}{=}}}}{1}
	{|}{{{\color{punct}{|}}}}{1}
	{\^}{{{\color{punct}{\^{}}}}}{1}
	{\{}{{{\color{punct}{\{}}}}{1}
	{\}}{{{\color{punct}{\}}}}}{1}
	{[}{{{\color{punct}{[}}}}{1}
	{]}{{{\color{punct}{]}}}}{1}
	{)}{{{\color{punct}{)}}}}{1}
	{(}{{{\color{punct}{(}}}}{1}
	{<}{{{\color{punct}{<}}}}{1}
	{>}{{{\color{punct}{>}}}}{1}
	{*}{{{\color{punct}{*}}}}{1}
	{?}{{{\color{punct}{?}}}}{1}
	{:}{{{\color{punct}{:}}}}{1}
	{,}{{{\color{punct}{,}}}}{1}
	{\&}{{{\color{punct}{\&}}}}{1}
	{!}{{{\color{punct}{!}}}}{1}
	{-}{{{\color{punct}{-}}}}{1}
	{+}{{{\color{punct}{+}}}}{1}
	{.}{{{\color{punct}{.}}}}{1}
	{\%}{{{\color{punct}{\%}}}}{1}
	{/}{{{\color{punct}{/}}}}{1}
	{\~}{{{$\color{punct}{\sim}$}}}{1}
	{;}{{{\color{punct}{;}}}}{1}
	%{"}{{{\ProcessQuote{"}}}}1% Disable coloring within double quotes
	%{'}{{{\ProcessQuote{'}}}}1% Disable coloring within single quote
	{0}{{{\ColorIfNotInString{0}}}}1
	{1}{{{\ColorIfNotInString{1}}}}1
	{2}{{{\ColorIfNotInString{2}}}}1
	{3}{{{\ColorIfNotInString{3}}}}1
	{4}{{{\ColorIfNotInString{4}}}}1
	{5}{{{\ColorIfNotInString{5}}}}1
	{6}{{{\ColorIfNotInString{6}}}}1
	{7}{{{\ColorIfNotInString{7}}}}1
	{8}{{{\ColorIfNotInString{8}}}}1
	{9}{{{\ColorIfNotInString{9}}}}1,
}

\lstset{
	language=py,
	%
	captionpos=b,                    % sets the caption-position to bottom
	mathescape=true,
	keepspaces=true,
	showspaces=false,
	showstringspaces=false,          % underline spaces within strings only
	showtabs=false,                  % show tabs within strings adding particular underscores
	stepnumber=1,
	tabsize=4,
	title=\lstname,
	morestring=[b]",
	morestring=[b]',
	belowskip=-0.8 \baselineskip,
	%
	numberstyle=\footnotesize\color{gray},
	rulecolor=\color{black},
	basicstyle=\ttfamily\small,
	commentstyle=\itshape,
	backgroundcolor=\color{codebg},
	keywordstyle=\color{blue},
	commentstyle=\color{orange}\itshape,
	stringstyle=\color{red},
}

\lstdefinestyle{output}{
	basicstyle=\small\ttfamily,
	numbers=none,
	frame=tblr,
	columns=fullflexible,
	backgroundcolor=\color{blue!10},
	linewidth=0.9\linewidth,
	xleftmargin=0.1\linewidth
}